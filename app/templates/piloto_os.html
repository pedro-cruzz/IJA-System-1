{% extends "base.html" %} {% block extra_styles %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/components/tables.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/components/forms.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/components/buttons.css') }}"
/>

<style>
  /* ========= MOBILE: tabela vira cards (mesmo padrão do dashboard) ========= */
  @media (max-width: 768px) {
    .container-fluid.py-4 {
      padding-left: 12px !important;
      padding-right: 12px !important;
    }

    .d-flex.justify-content-between.align-items-center.mb-4 {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 12px;
    }
    .d-flex.justify-content-between.align-items-center.mb-4 .btn {
      width: 100%;
    }

    .card.shadow-sm.rounded-4.border-0.overflow-hidden {
      background: transparent !important;
      box-shadow: none !important;
      overflow: visible !important;
    }
    .card.shadow-sm.rounded-4.border-0.overflow-hidden .card-body.p-0 {
      padding: 0 !important;
    }

    .table-responsive {
      overflow: visible !important;
      padding-bottom: 12px !important;
    }

    thead.table-light {
      display: none !important;
    }

    tbody {
      display: flex !important;
      flex-direction: column !important;
      gap: 18px !important;
      padding: 4px 0 0 0 !important;
    }

    tbody tr {
      display: block !important;
      background: var(--color-bg-white) !important;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      border-radius: 18px !important;
      box-shadow: var(--shadow-md) !important;
      overflow: hidden !important;
    }

    .table-hover > tbody > tr:hover > * {
      background: transparent !important;
    }

    tbody tr td {
      display: grid !important;
      grid-template-columns: 128px 1fr;
      column-gap: 14px;
      align-items: start !important;
      padding: 16px 16px !important;
      border: 0 !important;
      text-align: left !important;
      background: transparent !important;
      color: var(--color-text-main) !important;
    }

    tbody tr td + td {
      border-top: 1px solid rgba(0, 0, 0, 0.08) !important;
    }

    /* Labels (4 colunas) */
    tbody tr td:nth-child(1)::before {
      content: "Agendamento";
    }
    tbody tr td:nth-child(2)::before {
      content: "Local / UVIS";
    }
    tbody tr td:nth-child(3)::before {
      content: "Status";
    }
    tbody tr td:nth-child(4)::before {
      content: "Ações";
    }

    tbody tr td::before {
      font-weight: 700;
      color: var(--color-text-muted);
      font-size: 0.82rem;
      line-height: 1.15;
      padding-top: 2px;
      letter-spacing: 0.2px;
    }

    tbody tr td > * {
      min-width: 0;
    }

    /* ações em coluna */
    tbody tr td:nth-child(4) .d-flex.gap-2 {
      flex-direction: column;
      width: 100%;
    }
    tbody tr td:nth-child(4) .btn,
    tbody tr td:nth-child(4) button.btn {
      width: 100%;
      justify-content: center;
    }

    /* “vazio” */
    tbody tr td[colspan] {
      display: block !important;
      padding: 26px 16px !important;
      text-align: center !important;
    }
    tbody tr td[colspan]::before {
      content: none !important;
      display: none !important;
    }

    /* MODAL fullscreen no mobile (mesmo padrão) */
    .modal .modal-dialog {
      margin: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
      height: 100% !important;
    }
    .modal .modal-content {
      height: 100vh !important;
      border-radius: 0 !important;
      border: 0 !important;
      background: var(--color-bg-white) !important;
      color: var(--color-text-main) !important;
    }
    .modal .modal-header,
    .modal .modal-footer {
      position: sticky;
      background: var(--color-bg-white) !important;
      z-index: 10;
    }
    .modal .modal-header {
      top: 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    .modal .modal-footer {
      bottom: 0;
      border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    .modal .modal-body {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px !important;
    }
    .modal .modal-footer .btn {
      width: 100%;
    }
  }

  @media (max-width: 420px) {
    tbody tr td {
      grid-template-columns: 112px 1fr !important;
    }
    tbody tr td::before {
      font-size: 0.78rem;
    }
  }

  /* ========= DARK MODE (divisórias do mobile) ========= */
  @media (max-width: 768px) {
    html.dark-mode tbody tr,
    body.dark-mode tbody tr {
      border-color: #233549 !important;
    }
    html.dark-mode tbody tr td + td,
    body.dark-mode tbody tr td + td {
      border-top-color: #233549 !important;
    }
    html.dark-mode .modal .modal-header,
    body.dark-mode .modal .modal-header {
      border-bottom-color: #233549 !important;
    }
    html.dark-mode .modal .modal-footer,
    body.dark-mode .modal .modal-footer {
      border-top-color: #233549 !important;
    }
  }

  /* util */
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
    letter-spacing: 0.2px;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4" style="max-width: 1200px">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-dark m-0">
        <i class="bi bi-clipboard-check me-2 text-primary"></i> Ordens de
        Serviço
      </h2>
      <div class="text-muted small mt-1">
        Exibindo apenas: <b>APROVADA</b> / <b>APROVADA COM RECOMENDAÇÕES</b>
      </div>
    </div>

    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>

  {% if pedidos and pedidos|length > 0 %}
  <div class="card shadow-sm rounded-4 border-0 overflow-hidden">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-4">Agendamento</th>
              <th style="width: 48%">Localização / UVIS</th>
              <th class="text-center">Situação</th>
              <th class="text-center pe-4" style="width: 220px">Ações</th>
            </tr>
          </thead>

          <tbody>
            {% for s in pedidos %}
            <tr>
              <td class="ps-4">
                <strong class="text-main">
                  {{ s.data_agendamento.strftime('%d/%m/%Y') if
                  s.data_agendamento else '-' }}
                </strong>
                <br />
                <small class="text-muted">
                  {% if s.hora_agendamento %} {{
                  s.hora_agendamento.strftime("%H:%M") if
                  s.hora_agendamento.strftime else s.hora_agendamento }} {% else
                  %}-{% endif %}
                </small>
              </td>

              <td>
                <div class="d-flex flex-column">
                  <span class="fw-bold text-main">
                    {{ s.logradouro or '-' }}, {{ s.numero or 'S/N' }} {% if
                    s.complemento %}<span class="fw-normal text-muted"
                      >({{ s.complemento }})</span
                    >{% endif %}
                  </span>

                  <small class="text-muted">
                    {{ s.bairro or '-' }} - {{ s.cidade or '-' }}/{{ s.uf or '-'
                    }}
                  </small>

                  <div class="mt-1 d-flex flex-wrap gap-2 align-items-center">
                    {% if s.foco %}
                    <span class="badge bg-secondary">{{ s.foco }}</span>
                    {% endif %} {% if s.usuario %}
                    <span class="badge bg-light text-dark border">
                      <i class="bi bi-buildings-fill me-1"></i>{{
                      s.usuario.nome_uvis }}
                    </span>
                    {% if s.usuario.regiao %}
                    <span class="badge bg-light text-dark border"
                      >{{ s.usuario.regiao }}</span
                    >
                    {% endif %} {% endif %} {% if s.latitude %}
                    <i
                      class="bi bi-geo-alt-fill text-danger"
                      title="Localização GPS salva"
                    ></i>
                    {% endif %}
                  </div>
                </div>
              </td>

              <td class="text-center">
                {% set st = (s.status or '') %} {% if 'RECOMENDA' in st %}
                <span class="badge bg-warning text-dark rounded-pill"
                  >Aprovado c/ Recomendações</span
                >
                {% elif 'APROVAD' in st %}
                <span class="badge bg-success rounded-pill">Aprovado</span>
                {% elif 'CONCLU' in st %}
                <span class="badge bg-primary rounded-pill">Concluído</span>
                {% else %}
                <span class="badge bg-secondary rounded-pill"
                  >{{ st or '—' }}</span
                >
                {% endif %} {% if s.protocolo %}
                <div class="small text-muted mt-1 mono">{{ s.protocolo }}</div>
                {% endif %}
              </td>

              <td class="text-center pe-4">
                <div class="d-flex gap-2 justify-content-center">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#modalDetalhes{{ s.id }}"
                  >
                    <i class="bi bi-eye"></i> Detalhes
                  </button>

                  <form
                    method="POST"
                    action="{{ url_for('main.piloto_concluir_os', os_id=s.id) }}"
                    class="m-0 form-concluir"
                  >
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check2-circle"></i> Concluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% else %}
  <div class="alert alert-info shadow-sm rounded-4 border-0">
    Nenhuma ordem de serviço liberada para você no momento.
  </div>
  {% endif %} {# Paginação #} {% if paginacao and paginacao.pages > 1 %}
  <nav aria-label="Navegação de páginas" class="mt-4">
    <ul class="pagination justify-content-center flex-wrap">
      <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
        <a
          class="page-link"
          href="{{ url_for('main.piloto_os', page=paginacao.prev_num, **request.args) }}"
          >Anterior</a
        >
      </li>

      {% for pg in paginacao.iter_pages() %} {% if pg %} {% if pg ==
      paginacao.page %}
      <li class="page-item active"><span class="page-link">{{ pg }}</span></li>
      {% else %}
      <li class="page-item">
        <a
          class="page-link"
          href="{{ url_for('main.piloto_os', page=pg, **request.args) }}"
          >{{ pg }}</a
        >
      </li>
      {% endif %} {% else %}
      <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %} {% endfor %}

      <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
        <a
          class="page-link"
          href="{{ url_for('main.piloto_os', page=paginacao.next_num, **request.args) }}"
          >Próxima</a
        >
      </li>
    </ul>
  </nav>
  {% endif %} {# ========================= MODAIS (1 por OS)
  ========================= #} {% for p in pedidos %}
  <div
    class="modal fade"
    id="modalDetalhes{{ p.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalhes da OS #{{ p.id }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <h6 class="text-primary border-bottom pb-2 fw-bold">
            <i class="bi bi-geo-alt-fill"></i> Localização
          </h6>

          <p class="mb-1 small">
            <strong>Endereço:</strong>
            {{ p.logradouro }}, {{ p.numero or 'S/N' }} {{ '(' ~ p.complemento ~
            ')' if p.complemento else '' }}
          </p>

          <p class="mb-2 small">
            <strong>Bairro:</strong> {{ p.bairro or '-' }} - {{ p.cidade or '-'
            }}/{{ p.uf or '-' }}
          </p>

          {% if p.latitude and p.longitude %}
          <div
            class="d-flex justify-content-between align-items-center p-2 rounded border mb-3"
          >
            <div>
              <small class="text-muted d-block">Coordenadas:</small>
              <strong class="font-monospace small"
                >{{ p.latitude }}, {{ p.longitude }}</strong
              >
            </div>
            <a
              href="https://www.google.com/maps/search/?api=1&query={{ p.latitude }},{{ p.longitude }}"
              target="_blank"
              rel="noopener"
              class="btn btn-sm btn-outline-danger"
            >
              <i class="bi bi-map"></i> Ver Mapa
            </a>
          </div>
          {% endif %}

          <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
            <i class="bi bi-building"></i> UVIS
          </h6>

          <div class="row g-2 mb-3">
            <div class="col-12">
              <small class="text-muted d-block">Unidade:</small>
              <strong>{{ p.usuario.nome_uvis if p.usuario else '--' }}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Região:</small>
              <strong
                >{{ p.usuario.regiao if p.usuario and p.usuario.regiao else '--'
                }}</strong
              >
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Código Setor:</small>
              <strong
                >{{ p.usuario.codigo_setor if p.usuario and
                p.usuario.codigo_setor else '--' }}</strong
              >
            </div>
          </div>

          <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
            <i class="bi bi-paperclip"></i> Anexo
          </h6>

          {% if p.anexo_path %}
          <div
            class="d-flex justify-content-between align-items-center p-2 rounded border mb-3"
          >
            <div>
              <small class="text-muted d-block">Arquivo:</small>
              <strong class="small">{{ p.anexo_nome or 'Anexo' }}</strong>
            </div>

            <a
              href="{{ url_for('main.baixar_anexo', id=p.id) }}"
              target="_blank"
              rel="noopener"
              class="btn btn-sm btn-outline-primary"
            >
              <i class="bi bi-download"></i> Abrir / Baixar
            </a>
          </div>
          {% else %}
          <div class="alert alert-secondary py-2 small mb-3">
            Nenhum anexo enviado.
          </div>
          {% endif %}

          <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
            <i class="bi bi-sliders"></i> Operação
          </h6>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <small class="text-muted d-block">Foco:</small>
              <strong>{{ p.foco or '--' }}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Tipo de Visita:</small>
              <strong class="text-capitalize"
                >{{ p.tipo_visita or '--' }}</strong
              >
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <small class="text-muted d-block">Altura:</small>
              <strong>{{ p.altura_voo or '--' }}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Apoio CET?</small>
              {% if p.apoio_cet %}
              <span class="badge bg-warning text-dark">SIM</span>
              {% else %}
              <span class="badge bg-secondary">NÃO</span>
              {% endif %}
            </div>
          </div>

          {% if p.observacao %}
          <div class="p-2 rounded border mb-3">
            <small class="text-muted d-block fw-bold"
              >Observação do Usuário:</small
            >
            <em class="small">"{{ p.observacao }}"</em>
          </div>
          {% endif %}

          <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
            <i class="bi bi-shield-check"></i> Situação
          </h6>

          {% if p.status and ('RECOMENDA' in p.status) %}
          <div class="alert alert-warning mb-0">
            <strong class="d-block"
              ><i class="bi bi-exclamation-triangle"></i> Aprovado com
              Recomendações</strong
            >
            <small>Protocolo: {{ p.protocolo or '--' }}</small>
          </div>
          {% elif p.status and ('APROVAD' in p.status) %}
          <div class="alert alert-success mb-0">
            <strong class="d-block"
              ><i class="bi bi-check-circle"></i> Aprovado</strong
            >
            <small>Protocolo: {{ p.protocolo or '--' }}</small>
          </div>
          {% else %}
          <div class="alert alert-secondary mb-0">
            <strong class="d-block"
              ><i class="bi bi-info-circle"></i> Status</strong
            >
            <small>{{ p.status or '--' }}</small>
          </div>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %} {% block scripts %}
<script>
  // Confirmação “Concluir OS”
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".form-concluir").forEach((form) => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const isDarkMode = document.body.classList.contains("dark-mode");
        const submitButton = form.querySelector('button[type="submit"]');

        Swal.fire({
          title: "Concluir OS?",
          text: "Ao confirmar, a ordem de serviço será marcada como CONCLUÍDO.",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Sim, concluir",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#198754",
          cancelButtonColor: "#6c757d",
          customClass: { popup: isDarkMode ? "swal2-dark-mode" : "" },
        }).then((result) => {
          if (result.isConfirmed) {
            if (typeof showLoadingState === "function")
              showLoadingState(submitButton);
            form.submit();
          }
        });
      });
    });
  });
</script>
{% endblock %}
