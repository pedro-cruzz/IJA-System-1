{% extends "base.html" %}

{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/chatbot.css') }}">
{% endblock %}

{% block content %}

{# --- IN√çCIO DO CONTAINER PADRONIZADO --- #}
<div class="container-fluid py-4" style="max-width: 1200px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-dark"><i class="bi bi-shield-lock-fill me-2 text-primary"></i> Painel de Gest√£o</h2>

        {# BOT√ïES EXPORTAR #}
        <div class="d-flex gap-2">
            {% if is_editable %}
            <form method="GET" action="{{ url_for('main.exportar_excel') }}" class="form-exportar p-0 m-0">
                <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
                <input type="hidden" name="unidade" value="{{ request.args.get('unidade', '') }}">
                <input type="hidden" name="regiao" value="{{ request.args.get('regiao', '') }}">

                <button type="submit" class="btn btn-success shadow-sm">
                    <i class="bi bi-file-earmark-excel-fill"></i> <span class="d-none d-md-inline">Exportar Excel</span>
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    {# --- FILTROS EM "SANFONA" (Accordion) --- #}
    <div class="card shadow-sm rounded-4 mb-4 border-0">
        <div class="card-header border-0 p-3 d-flex justify-content-between align-items-center cursor-pointer"
             data-bs-toggle="collapse"
             data-bs-target="#collapseFiltros"
             aria-expanded="false"
             style="cursor: pointer;">

            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-funnel-fill text-primary"></i>
                <span class="text-dark">Filtros de Busca</span>
                {% if request.args.get('status') or request.args.get('unidade') or request.args.get('regiao') %}
                    <span class="badge bg-danger rounded-circle p-1" style="width: 8px; height: 8px;"></span>
                {% endif %}
            </div>
            <i class="bi bi-chevron-down text-muted"></i>
        </div>

        <div class="collapse {% if request.args.get('status') or request.args.get('unidade') or request.args.get('regiao') %}show{% endif %}" id="collapseFiltros">
            <div class="card-body pt-0">
                <form method="GET">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="small text-muted">Status:</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="PENDENTE" {{ 'selected' if request.args.get('status')=='PENDENTE' else '' }}>‚ö™Ô∏è Pendente</option>
                                <option value="EM AN√ÅLISE" {{ 'selected' if request.args.get('status')=='EM AN√ÅLISE' else '' }}>üü° Em An√°lise</option>
                                <option value="APROVADO" {{ 'selected' if request.args.get('status')=='APROVADO' else '' }}>üü¢ Aprovado</option>
                                <option value="APROVADO COM RECOMENDA√á√ïES" {{ 'selected' if request.args.get('status')=='APROVADO COM RECOMENDA√á√ïES' else '' }}>üü† Aprovado c/ rec.</option>
                                <option value="NEGADO" {{ 'selected' if request.args.get('status')=='NEGADO' else '' }}>üî¥ Negado</option>
                                <option value="CONCLU√çDO" {{ 'selected' if request.args.get('status')=='CONCLU√çDO' else '' }}>üü£ Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="small text-muted">Unidade:</label>
                            <input type="text" name="unidade" class="form-control form-control-sm" placeholder="Nome da UVIS..." value="{{ request.args.get('unidade', '') }}">
                        </div>
                       <div class="col-md-3">
                        <label class="small text-muted">Regi√£o:</label>

                        {% set reg = (request.args.get('regiao','') or '')|upper %}

                        <select name="regiao" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            <option value="NORTE" {% if reg == 'NORTE' %}selected{% endif %}>NORTE</option>
                            <option value="SUL" {% if reg == 'SUL' %}selected{% endif %}>SUL</option>
                            <option value="LESTE" {% if reg == 'LESTE' %}selected{% endif %}>LESTE</option>
                            <option value="OESTE" {% if reg == 'OESTE' %}selected{% endif %}>OESTE</option>
                        </select>
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                            <button class="btn btn-success btn-sm w-100" type="submit"><i class="bi bi-search"></i> Filtrar</button>
                            {% if request.args.get('status') or request.args.get('unidade') or request.args.get('regiao') %}
                                <a href="{{ url_for(request.endpoint) }}" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="bi bi-x-lg"></i> Limpar
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    {# --- TABELA H√çBRIDA (SANFONA NO MOBILE / TABELA NO PC) --- #}
    <div class="card shadow-sm rounded-4 border-0 overflow-hidden">
        <table class="table table-hover align-middle mb-0 table-accordion">

            {# HEADER: OCULTO NO MOBILE (d-none), VIS√çVEL NO DESKTOP (d-lg-table-header-group) #}
            <thead class="d-none d-lg-table-header-group">
                <tr>
                    <th style="width: 25%">Unidade</th>
                    <th style="width: 40%">Dados da Opera√ß√£o</th>
                    <th style="width: 35%">{% if is_editable %}Decis√£o & Ajustes{% else %}Status Atual & Protocolo{% endif %}</th>
                </tr>
            </thead>

            <tbody>
                {% for p in pedidos %}

                {# === LINHA PRINCIPAL (CABE√áALHO DA SANFONA NO MOBILE / LINHA COMUM NO PC) === #}
                <tr class="main-row"
                        onclick="
                        if(event.target.closest('a, button, form, label, input, select, textarea')) return;
                        bootstrap.Collapse.getOrCreateInstance(
                            document.getElementById('accordion{{ p.id }}')
                        ).toggle();                       "
                >
                    {# COLUNA 1: IDENTIFICA√á√ÉO (SEMPRE VIS√çVEL) #}
                    <td class="ps-3 py-3 m-0 align-top">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex flex-column">

                                <!-- NOME -->
                                <strong class="text-primary fs-6">
                                    {{ p.usuario.nome_uvis }}
                                </strong>

                                <div class="mt-3">
                                    <!-- STATUS -->
                                    <div class="mt-1">
                                        <span class="badge
                                            {% if p.status=='PENDENTE' %}bg-secondary
                                            {% elif p.status=='EM AN√ÅLISE' %}bg-warning
                                            {% elif p.status=='APROVADO COM RECOMENDA√á√ïES' %}bg-recomended
                                            {% elif p.status=='APROVADO' %}bg-success
                                            {% elif p.status=='NEGADO' %}bg-danger
                                            {% else %}bg-warning text-dark{% endif %}">
                                            {{ p.status }}
                                        </span>
                                    </div>

                                    <!-- REGI√ÉO -->
                                    <div class="mt-1">
                                        <span class="badge bg-secondary">
                                            {{ p.usuario.regiao }}
                                        </span>
                                    </div>
                                </div>

                            </div>

                            <!-- SETA MOBILE -->
                            <i class="bi bi-chevron-down text-muted d-lg-none p-2"></i>
                        </div>

                        <div class="small text-muted mt-4 border-top pt-2">
                            <i class="bi bi-calendar-event me-1"></i> {{ p.data_agendamento.strftime('%d/%m/%Y') }} √†s {{ p.hora_agendamento.strftime('%H:%M') }}
                        </div>

                        {# Endere√ßo Desktop (Escondido no Mobile) #}
                        <div class="d-none d-lg-block mt-2 small text-muted">
                            <i class="bi bi-geo-alt"></i> {{ p.logradouro }}, {{ p.numero or 'S/N' }} - {{ p.bairro }}
                            <br>CEP: {{ p.cep }}
                        </div>

                        {# Bot√µes de Admin Desktop #}
                        {% if current_user.tipo_usuario == 'admin' %}
                        <div class="d-none d-lg-flex gap-1 mt-4">
                            <a href="{{ url_for('main.admin_editar_completo', id=p.id) }}"
                                class="btn btn-sm btn-success"
                                onclick="event.stopPropagation();">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                            <form class="form-deletar"
                                action="{{ url_for('main.deletar_registro', id=p.id) }}"
                                method="POST"
                                onclick="event.stopPropagation();">
                                <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i> Deletar</button>
                            </form>
                        </div>
                        {% endif %}
                    </td>

                    {# COLUNA 2: DADOS (S√ì DESKTOP) #}
                    <td class="align-top pt-3 d-none d-lg-table-cell">
                        {% if p.latitude %}
                        <div class="d-flex justify-content-between p-2 rounded border mb-2">
                            <small class="font-monospace fw-bold">{{ p.latitude }}, {{ p.longitude }}</small>
                            <a href="http://maps.google.com/maps?q={{ p.latitude }},{{ p.longitude }}" target="_blank" class="btn btn-sm btn-outline-danger py-0"><i class="bi bi-map-fill"></i></a>
                        </div>
                        {% endif %}
                        <div class="row gap-2 small mt-3">
                            <div class="col-6"><span>Tipo:</span> <strong>{{ p.tipo_visita }}</strong></div>
                            <div class="col-6"><span>Altura:</span> <strong>{{ p.altura_voo }}</strong></div>
                            <div class="col-12"><span>Foco:</span> <strong>{{ p.foco }}</strong></div>
                            <div class="col-6 mt-2">
                                <span>Apoio CET?</span>
                                {% if p.apoio_cet %}
                                    <div class="mt-1">
                                        <span class="badge bg-success text-light">Sim</span>
                                    </div>
                                {% else %}
                                    <div class="mt-1">
                                        <span class="badge bg-danger text-light">N√£o</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-3">
                            <span>Observa√ß√£o</span>
                            {% if p.observacao %}
                            <div class=" p-1 border rounded fst-italic small">
                                {{ p.observacao }}
                            </div>{% endif %}</div>
                        
                    </td>

                    {# COLUNA 3: FORMUL√ÅRIO (S√ì DESKTOP) #}
                    <td class="align-top pt-3 d-none d-lg-table-cell bg-opacity-10">
                        {% if is_editable %}
                            {# --- FORMUL√ÅRIO DESKTOP ORIGINAL --- #}
                            <form action="{{ url_for('main.atualizar', id=p.id) }}" method="POST" enctype="multipart/form-data">
                                <div class="row g-1 mb-2">
                                    <div class="col-6"><input name="latitude" class="form-control form-control-sm" value="{{ p.latitude or '' }}" placeholder="Lat"></div>
                                    <div class="col-6"><input name="longitude" class="form-control form-control-sm" value="{{ p.longitude or '' }}" placeholder="Long"></div>
                                </div>
                                <input name="protocolo" class="form-control form-control-sm mb-2" placeholder="Protocolo" value="{{ p.protocolo or '' }}">
                                <div class="p-2 border rounded gap-1 d-flex flex-column">
                                    <div>
                                        <label class="form-label">Status</label>
                                    <select name="status"
                                            class="form-select form-select-sm"
                                            data-jid="{{ p.id }}"
                                            onchange="toggleJustificativa(this, this.dataset.jid)">
                                        <option value="PENDENTE" {% if p.status=='PENDENTE' %}selected{% endif %}>‚ö™Ô∏è Pendente</option>
                                        <option value="EM AN√ÅLISE" {% if p.status=='EM AN√ÅLISE' %}selected{% endif %}>üü° Em An√°lise</option>
                                        <option value="APROVADO COM RECOMENDA√á√ïES" {% if p.status=='APROVADO COM RECOMENDA√á√ïES' %}selected{% endif %}>üü† Aprovado com Recomenda√ß√µes</option>
                                        <option value="APROVADO" {% if p.status=='APROVADO' %}selected{% endif %}>üü¢ Aprovar</option>
                                        <option value="NEGADO" {% if p.status=='NEGADO' %}selected{% endif %}>üî¥ Negar</option>
                                    </select>
                                    </div>
                                    <div>
                                        <label class="form-label mt-2">Piloto respons√°vel</label>
                                        <select class="form-select form-select-sm" name="piloto_id" {% if not is_editable %}disabled{% endif %}>
                                            {# ‚úÖ op√ß√£o para LIMPAR #}
                                            <option value="" {% if not p.piloto_id %}selected{% endif %}>‚Äî Sem piloto (remover atribui√ß√£o) ‚Äî</option>

                                            {# (opcional) separador visual #}
                                            <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>

                                            {# lista normal #}
                                            {% for pilot in pilotos %}
                                                <option value="{{ pilot.id }}" {% if p.piloto_id == pilot.id %}selected{% endif %}>
                                                {{ pilot.nome_piloto }}{% if pilot.regiao %} ({{ pilot.regiao }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div id="boxJustificativa{{ p.id }}" style="display: none;" class="">
                                        <label class="form-label mt-2">Justificativa</label>
                                        <input name="justificativa" id="inputJustificativa{{ p.id }}" class="form-control form-control-sm" value="{{ p.justificativa or '' }}" placeholder="Justificativa">
                                    </div>

                                    <div class="d-flex gap-1 mt-2">
                                        <label id="btnAnexo{{ p.id }}" for="inputPdf{{ p.id }}" class="btn btn-sm btn-outline-primary text-truncate justify-content-center vw-100">
                                            <span id="textoDisplay{{ p.id }}"><i class="bi bi-paperclip"></i> {{ p.anexo_nome or 'Anexar' }}</span>
                                        </label>
                                        <a id="btnVisualizar{{ p.id }}"
                                           href="{{ url_for('main.baixar_anexo', id=p.id) if p.anexo_path else '#' }}"
                                           target="_blank"
                                           class="btn btn-sm btn-outline-primary {% if not p.anexo_path %}d-none{% endif %}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button type="submit"
                                                form="formRemoverAnexo{{ p.id }}"
                                                class="btn btn-sm btn-outline-danger {% if not p.anexo_path %}d-none{% endif %}"
                                                id="btnRemover{{ p.id }}">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>

                                    <input type="file" name="anexo" id="inputPdf{{ p.id }}" class="d-none" onchange="processarArquivo(this, '{{ p.id }}')">

                                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">Salvar</button>
                                </div>
                            </form>

                            {# Form Fantasma Remover Desktop #}
                            {% if p.anexo_path %}
                            <form action="{{ url_for('main.remover_anexo', id=p.id) }}"
                                  method="POST"
                                  class="form-deletar d-none"
                                  id="formRemoverAnexo{{ p.id }}"></form>
                            {% endif %}
                        {% else %}
                            <div class="text-center"><span class="badge bg-secondary">{{ p.status }}</span></div>
                        {% endif %}
                    </td>
                </tr>

                {# === LINHA 2: SANFONA DETALHES (S√ì MOBILE) === #}
                <tr class="d-lg-none p-0 border-0">
                    <td colspan="3" class="p-0 border-0">
                        <div class="collapse" id="accordion{{ p.id }}">
                            <div class="p-3 border-bottom">

                                {# --- 1. DADOS COMPLETOS MOBILE --- #}
                                <div class="p-3 rounded border mb-3">
                                    <h6 class="small fw-bold text-muted mb-2 text-uppercase">Detalhes</h6>
                                    <p class="small text-dark mb-2">{{ p.logradouro }}, {{ p.numero }} - {{ p.bairro }}</p>

                                    {% if p.latitude and p.longitude %}
                                    <div class="rounded p-2 mb-2">
                                        <div class="small text-muted mb-1">
                                            <i class="bi bi-crosshair text-danger me-1"></i> Coordenadas
                                        </div>
                                        <div class="fw-bold font-monospace text-dark">
                                            {{ p.latitude }}, {{ p.longitude }}
                                        </div>
                                    </div>
                                    <div class="d-grid mb-3">
                                        <a href="http://maps.google.com/maps?q={{ p.latitude }},{{ p.longitude }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-map-fill text-danger me-2"></i> Ver no Mapa
                                        </a>
                                    </div>
                                    {% endif %}

                                    <div class="row g-2 small text-muted">
                                        <div class="col-6"><strong>Tipo:</strong> {{ p.tipo_visita }}</div>
                                        <div class="col-6"><strong>Alt:</strong> {{ p.altura_voo }}</div>
                                        <div class="col-6"><strong>Foco:</strong> {{ p.foco }}</div>
                                        <div class="col-6">
                                            <span>Apoio CET?</span>
                                            {% if p.apoio_cet %}
                                                <div class="mt-1">
                                                    <span class="badge bg-success text-light">Sim</span>
                                                </div>
                                            {% else %}
                                                <div class="mt-1">
                                                    <span class="badge bg-danger text-light">N√£o</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if p.observacao %}<div class="alert alert-warning small p-2 mt-2 mb-0">{{ p.observacao }}</div>{% endif %}
                                </div>

                                {# --- 2. FORMUL√ÅRIO MOBILE (C√≥pia adaptada para Mobile) --- #}
                                {% if is_editable %}
                                <div class="p-3 rounded border shadow-sm">
                                    <h6 class="small fw-bold text-primary mb-3 text-uppercase">Tomar Decis√£o</h6>

                                    <form action="{{ url_for('main.atualizar', id=p.id) }}" method="POST" enctype="multipart/form-data">
                                        <div class="d-none">
                                            <input name="latitude" value="{{ p.latitude }}">
                                            <input name="longitude" value="{{ p.longitude }}">
                                        </div>
                                        <input name="protocolo" class="form-control mb-3" placeholder="Protocolo DECEA" value="{{ p.protocolo or '' }}">
                                        <label class="form-label mt-2">Piloto respons√°vel</label>
                                        <select class="form-select form-select-sm" name="piloto_id" {% if not is_editable %}disabled{% endif %}>
                                            {# ‚úÖ op√ß√£o para LIMPAR #}
                                            <option value="" {% if not p.piloto_id %}selected{% endif %}>‚Äî Sem piloto (remover atribui√ß√£o) ‚Äî</option>

                                            {# (opcional) separador visual #}
                                            <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>

                                            {# lista normal #}
                                            {% for pilot in pilotos %}
                                                <option value="{{ pilot.id }}" {% if p.piloto_id == pilot.id %}selected{% endif %}>
                                                {{ pilot.nome_piloto }}{% if pilot.regiao %} ({{ pilot.regiao }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>

                                        <label class="form-label mt-2">Piloto respons√°vel</label>
                                        <select name="status"
                                                class="form-select mb-3"
                                                data-jid="{{ p.id }}_mob"
                                                onchange="toggleJustificativa(this, this.dataset.jid)">
                                            <option value="PENDENTE" {% if p.status=='PENDENTE' %}selected{% endif %}>‚ö™Ô∏è Pendente</option>
                                            <option value="EM AN√ÅLISE" {% if p.status=='EM AN√ÅLISE' %}selected{% endif %}>üü° Em An√°lise</option>
                                            <option value="APROVADO" {% if p.status=='APROVADO' %}selected{% endif %}>üü¢ Aprovar</option>
                                            <option value="APROVADO COM RECOMENDA√á√ïES" {% if p.status=='APROVADO COM RECOMENDA√á√ïES' %}selected{% endif %}>üü† Aprovado com Recomenda√ß√µes</option>
                                            <option value="NEGADO" {% if p.status=='NEGADO' %}selected{% endif %}>üî¥ Negar</option>
                                        </select>

                                        <div id="boxJustificativa{{ p.id }}_mob" style="display: none;" class="mb-3">
                                            <textarea name="justificativa" id="inputJustificativa{{ p.id }}_mob" class="form-control" rows="2" placeholder="Motivo...">{{ p.justificativa }}</textarea>
                                        </div>

                                        <div class="anexo-actions mb-3">
                                            <label id="btnAnexo{{ p.id }}_mob"
                                                   for="inputPdf{{ p.id }}_mob"
                                                   class="btn btn-outline-primary btn-sm btn-anexo">
                                                <span id="textoDisplay{{ p.id }}_mob">
                                                    {{ p.anexo_nome or 'Anexar' }}
                                                </span>
                                            </label>

                                            {% if p.anexo_path %}
                                            <a id="btnVisualizar{{ p.id }}_mob"
                                               href="{{ url_for('main.baixar_anexo', id=p.id) if p.anexo_path else '#' }}"
                                               target="_blank"
                                               class="btn btn-sm btn-outline-primary {% if not p.anexo_path %}d-none{% endif %}">
                                                <i class="bi bi-eye"></i>
                                            </a>

                                            <button type="submit"
                                                    form="formRemoverAnexo{{ p.id }}_mob"
                                                    class="btn btn-sm btn-outline-danger {% if not p.anexo_path %}d-none{% endif %}"
                                                    id="btnRemover{{ p.id }}_mob">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            {% endif %}
                                        </div>

                                        <input type="file" name="anexo" id="inputPdf{{ p.id }}_mob" class="d-none" onchange="processarArquivo(this, '{{ p.id }}_mob')">

                                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2">Salvar Decis√£o</button>
                                    </form>

                                    {# Form Fantasma Remover Mobile (se existir anexo) #}
                                    {% if p.anexo_path %}
                                    <form action="{{ url_for('main.remover_anexo', id=p.id) }}"
                                          method="POST"
                                          class="form-deletar d-none"
                                          id="formRemoverAnexo{{ p.id }}_mob"></form>
                                    {% endif %}

                                    {% if current_user.tipo_usuario == 'admin' %}
                                    <div class="d-flex gap-1 mt-2 align-items-center justify-content-center">
                                        <a href="{{ url_for('main.admin_editar_completo', id=p.id) }}"
                                           class="btn btn-sm btn-success">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </a>
                                        <form class="form-deletar" action="{{ url_for('main.deletar_registro', id=p.id) }}"
                                              method="POST">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Deletar
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>

                {% else %}
                <tr><td colspan="3" class="text-center py-5">Nenhum registro.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        {# --- PAGINA√á√ÉO (MANTIDA IGUAL) --- #}
        {% if paginacao.pages > 1 %}
        <nav class="mt-4 pb-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.prev_num) }}">Anterior</a>
                </li>
                <li class="page-item disabled"><span class="page-link">{{ paginacao.page }} / {{ paginacao.pages }}</span></li>
                <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.next_num) }}">Pr√≥xima</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{# --- FIM DO CONTAINER PADRONIZADO --- #}

{# --- CHATBOT (Mantido igual) --- #}
{% if current_user.tipo_usuario == 'admin' %}
<button id="adminBotFab" class="bot-fab" title="Ajuda do painel" onclick="toggleAdminChat()">
    <i class="bi bi-robot"></i>
</button>

<div id="adminBotWindow" class="chat-window">
    <div class="bot-header">
        <div class="bot-title">
            <i class="bi bi-robot fs-5"></i>
            <div>Ajuda do Painel <span class="bot-badge ms-1">FAQ Admin</span></div>
        </div>
        <div class="d-flex gap-2">
            <button id="adminBotClear" class="btn-close-chat" title="Limpar"><i class="bi bi-trash"></i></button>
            <button id="adminBotClose" class="btn-close-chat"><i class="bi bi-x-lg"></i></button>
        </div>
    </div>
    <div class="bot-body">
        <div id="adminBotMessages" class="d-flex flex-column gap-2 mb-3"></div>
        <div class="chips-container mt-auto">
            <button class="chip" data-q="Como filtrar por status/unidade?">Filtros</button>
            <button class="chip" data-q="suporte">Suporte</button>
            <button class="chip" data-q="Como salvar decis√£o?">Salvar decis√£o</button>
            <button class="chip" data-q="Como exportar Excel?">Exportar Excel</button>
        </div>
    </div>
    <div class="bot-footer">
        <input id="adminBotInput" type="text" placeholder="Digite sua d√∫vida..." autocomplete="off">
        <button id="adminBotSend" class="btn-send"><i class="bi bi-send-fill"></i></button>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // --- L√ìGICA DE INTERFACE DE ARQUIVO ---
    function processarArquivo(input, id) {
        if (!input.files || !input.files.length) return;

        const file = input.files[0];

        const texto = document.getElementById('textoDisplay' + id);
        const btnVisualizar = document.getElementById('btnVisualizar' + id);
        const btnRemover = document.getElementById('btnRemover' + id);

        const url = URL.createObjectURL(file);

        if (texto) {
            texto.innerHTML = `<i class="bi bi-paperclip me-1"></i> ${file.name}`;
        }

        if (btnVisualizar) {
            btnVisualizar.href = url;
            btnVisualizar.classList.remove('d-none');
        }

        if (btnRemover) {
            btnRemover.classList.remove('d-none');
        }
    }

    // Fun√ß√£o para resumir nomes de arquivos longos
    function resumirNomeArquivo(nome, max = 22) {
        if (!nome) return "";
        if (nome.length <= max) return nome;

        const dot = nome.lastIndexOf(".");
        const ext = dot > 0 ? nome.slice(dot) : "";
        const base = dot > 0 ? nome.slice(0, dot) : nome;

        const keepStart = Math.max(8, Math.floor((max - ext.length - 3) * 0.6));
        const keepEnd = Math.max(5, (max - ext.length - 3) - keepStart);

        return base.slice(0, keepStart) + "..." + base.slice(-keepEnd) + ext;
    }

    // Resumo de nome (sem depender de .btn-anexo > span)
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('[id^="textoDisplay"]').forEach(span => {
            const original = (span.textContent || "").trim();
            if (!original) return;

            // tooltip com nome completo
            span.setAttribute("title", original);

            // tenta separar o nome do arquivo se tiver "üìé" textual, sen√£o usa tudo
            const cleaned = original.replace(/^üìé\s*/,'').trim();
            const resumido = resumirNomeArquivo(cleaned, 22);

            // preserva √≠cone <i> se existir
            const icon = span.querySelector("i");
            if (icon) {
                const iconClone = icon.cloneNode(true);
                span.innerHTML = "";
                span.appendChild(iconClone);
                span.insertAdjacentText("beforeend", " " + resumido);
            } else {
                span.textContent = resumido;
            }
        });
    });

    // --- TOGGLE JUSTIFICATIVA (s√≥ aparece em NEGADO) ---
    function toggleJustificativa(select, id) {
        const box = document.getElementById('boxJustificativa' + id);
        const input = document.getElementById('inputJustificativa' + id);
        if (!box || !input) return;

        if (select.value === 'NEGADO') {
            box.style.display = 'block';
            input.setAttribute('required', 'required');
        } else {
            box.style.display = 'none';
            input.removeAttribute('required');
        }
    }

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa justificativa em todos selects de status que tenham data-jid
        document.querySelectorAll('select[name="status"][data-jid]').forEach(select => {
            toggleJustificativa(select, select.dataset.jid);
        });

        // Chatbot logic (Mantido igual)
        (function () {
            if (window.ADMIN_CHAT_INIT) return;
            window.ADMIN_CHAT_INIT = true;
            const API_URL = "{{ url_for('main.admin_chatbot') }}";
            const fab = document.getElementById("adminBotFab");
            const chatWindow = document.getElementById("adminBotWindow");
            const box = document.getElementById("adminBotMessages");
            const input = document.getElementById("adminBotInput");
            const send = document.getElementById("adminBotSend");
            const closeBtns = document.querySelectorAll("#adminBotClose, #adminBotClear");

            if(!fab) return;

            function toggleChat() { chatWindow.classList.toggle('active'); if(chatWindow.classList.contains('active')) setTimeout(()=>input.focus(),300); }
            fab.addEventListener("click", toggleChat);
            closeBtns.forEach(b => b.addEventListener("click", (e) => {
                if(e.currentTarget.id === 'adminBotClear') box.innerHTML = '';
                else toggleChat();
            }));

            async function ask(txt) {
                const msg = (txt || input.value || "").trim();
                if(!msg) return;

                const divMe = document.createElement("div"); divMe.className="message user"; divMe.innerText=msg; box.appendChild(divMe);
                input.value="";

                const divBot = document.createElement("div"); divBot.className="message bot"; divBot.innerHTML='...'; box.appendChild(divBot);
                box.scrollTop = box.scrollHeight;

                try {
                    const r = await fetch(API_URL, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({message:msg})});
                    const d = await r.json();
                    divBot.innerHTML = d.answer || "Erro.";
                } catch(e) { divBot.innerHTML = "Erro de conex√£o."; }
            }
            if(send) send.addEventListener("click", ()=>ask());
            if(input) input.addEventListener("keydown", e=>{if(e.key==="Enter") ask()});
            document.querySelectorAll(".chip").forEach(c => c.addEventListener("click", ()=>ask(c.getAttribute('data-q'))));
        })();
    });
</script>
{% endblock %}
