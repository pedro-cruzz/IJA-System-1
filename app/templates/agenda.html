{% extends "base.html" %}
{% block extra_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/fullcalendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">

<div class="agenda-header mb-4">
  <div class="agenda-title">
    <h2 class="m-0 fw-bold">
      <i class="bi bi-calendar-event-fill me-2 text-primary"></i> Agenda
    </h2>
  </div>

  {% if current_user.is_authenticated and current_user.tipo_usuario == "admin" %}
  <div class="agenda-actions">
    <a href="{{ url_for('main.agenda_exportar_excel', all=1) }}"
       class="btn btn-outline-secondary btn-sm"
       title="Baixar base completa sem filtros">
      <i class="bi bi-download"></i>
      <span>Exportar Tudo</span>
    </a>

    <a href="{{ url_for('main.agenda_exportar_excel', **request.args.to_dict()) }}"
       class="btn btn-success btn-sm"
       title="Exportar com filtros atuais">
      <i class="bi bi-file-earmark-excel"></i>
      <span>Exportar Atual</span>
    </a>
  </div>
  {% endif %}
</div>

{# --- FILTROS DA AGENDA (PADRÃO SANFONA) --- #}
<div class="card shadow-sm rounded-4 mb-4 border-0">

  <div class="card-header border-0 p-3 d-flex justify-content-between align-items-center"
       data-bs-toggle="collapse"
       data-bs-target="#collapseFiltrosAgenda"
       aria-expanded="{{ 'true' if (filtros.uvis_id or filtros.status) else 'false' }}"
       style="cursor: pointer;">

    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-funnel-fill text-primary"></i>
      <span class="text-dark">Filtros de busca</span>

      {# bolinha só quando tem filtro REAL #}
      {% if filtros.uvis_id or filtros.status %}
        <span class="badge bg-danger rounded-circle p-1"
              style="width: 8px; height: 8px;"></span>
      {% endif %}
    </div>

    <i class="bi bi-chevron-down text-muted"></i>
  </div>

  {# abre somente quando tem filtro REAL (uvis/status) #}
  <div class="collapse {% if filtros.uvis_id or filtros.status %}show{% endif %}"
       id="collapseFiltrosAgenda">
    <div class="card-body pt-0">
      <form method="get" action="{{ url_for('main.agenda') }}">
        <div class="row g-2 align-items-end">

          {# UVIS (se permitido) #}
          {% if pode_filtrar_uvis %}
          <div class="col-md-3">
            <label class="small text-muted">UVIS:</label>
            <select class="form-select form-select-sm" name="uvis_id">
              <option value="">Todas</option>
              {% for id, nome in uvis_disponiveis %}
                <option value="{{ id }}"
                  {% if filtros.uvis_id|int == id|int %}selected{% endif %}>
                  {{ nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}

          {# STATUS #}
          <div class="col-md-3">
            <label class="small text-muted">Status:</label>
            <select class="form-select form-select-sm" name="status">
              <option value="">Todos</option>
              {% for s in status_opcoes %}
                <option value="{{ s }}"
                  {% if filtros.status == s %}selected{% endif %}>
                  {{ s }}
                </option>
              {% endfor %}
            </select>
          </div>

          {# MÊS #}
          <div class="col-4 col-md-2">
            <label class="small text-muted">Mês:</label>
            <select class="form-select form-select-sm" name="mes">
              {% for m in range(1, 13) %}
                <option value="{{ m }}"
                  {% if filtros.mes|int == m %}selected{% endif %}>
                  {{ "%02d"|format(m) }}
                </option>
              {% endfor %}
            </select>
          </div>

          {# ANO #}
          <div class="col-4 col-md-2">
            <label class="small text-muted">Ano:</label>
            <select class="form-select form-select-sm" name="ano">
              {% for a in anos_disponiveis %}
                <option value="{{ a }}"
                  {% if filtros.ano|int == a %}selected{% endif %}>
                  {{ a }}
                </option>
              {% endfor %}
            </select>
          </div>

          {# BOTÕES #}
          <div class="col-md-2 d-flex gap-2">
            <button type="submit" class="btn btn-success btn-sm">
              <i class="bi bi-funnel"></i> Filtrar
            </button>

            {# limpar só quando tem filtro REAL #}
            {% if filtros.uvis_id or filtros.status %}
              <a href="{{ url_for('main.agenda') }}"
                 class="btn btn-outline-secondary btn-sm"
                 title="Limpar filtros">
                <i class="bi bi-x-lg"></i> Limpar
              </a>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card shadow-sm rounded-4 border-0">
  <div class="card-body p-4">
    <div id="calendar"></div>
  </div>
</div>

</div>

<div class="modal fade" id="modalEvento" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow border-0">

      <div class="modal-header bg-light border-bottom-0 rounded-top-4">
        <h5 class="modal-title fw-bold text-primary">
          <i class="bi bi-info-circle me-2"></i> Detalhes do Agendamento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">

        <div class="mb-3">
          <label class="small text-muted fw-bold text-uppercase">UVIS</label>
          <div id="m-uvis" class="fs-5 fw-semibold text-dark"></div>
        </div>

        <div class="row mb-3">
          <div class="col-6">
            <label class="small text-muted fw-bold text-uppercase">Horário</label>
            <div class="d-flex align-items-center text-primary">
              <i class="bi bi-clock me-2"></i>
              <span id="m-hora" class="fw-bold fs-5"></span>
            </div>
          </div>
          <div class="col-6">
            <label class="small text-muted fw-bold text-uppercase">Foco</label>
            <div class="d-flex align-items-center text-dark">
              <i class="bi bi-crosshair me-2 text-secondary"></i>
              <span id="m-foco" class="fw-medium"></span>
            </div>
          </div>
        </div>

        <div class="mb-2">
          <label class="small text-muted fw-bold text-uppercase d-block mb-1">Situação</label>
          <span id="m-status" class="badge rounded-pill px-3 py-2 fs-6"></span>
        </div>

      </div>

      <div class="modal-footer border-top-0 pt-0">
        <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

<script id="eventos-dados" type="application/json">
  {{ eventos_json | safe }}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const eventos = JSON.parse(document.getElementById("eventos-dados").textContent || "[]");
    const calendarEl = document.getElementById("calendar");

    const hoje = new Date();
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    const toolbarRight = isMobile ? "listWeek" : "dayGridMonth,listWeek";

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: isMobile ? "listWeek" : "dayGridMonth",
      initialDate: hoje,

      locale: "pt-br",
      height: "auto",
      nowIndicator: true,
      dayMaxEvents: true,

      noEventsContent: () => "Nenhum agendamento encontrado.",

      allDayText: "Dia todo",
      moreLinkText: (n) => `+${n} mais`,
      weekText: "Semana",

      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: toolbarRight,
      },

      buttonText: {
        today: "Hoje",
        month: "Mês",
        week: "Semana",
        day: "Dia",
        list: "Lista",
      },

      listDayFormat: { weekday: "short", day: "2-digit", month: "2-digit" },
      listDaySideFormat: false,

      events: eventos,

      eventClick: function (info) {
        info.jsEvent.preventDefault();

        if (info.event.url) {
          window.location.href = info.event.url;
          return;
        }

        const p = info.event.extendedProps || {};

        document.getElementById("m-uvis").innerText = p.uvis || "-";
        document.getElementById("m-foco").innerText = p.foco || "-";
        document.getElementById("m-hora").innerText = p.hora || "-";

        const statusEl = document.getElementById("m-status");
        const statusText = p.status || "Indefinido";
        statusEl.innerText = statusText;

        statusEl.className = "badge rounded-pill px-3 py-2 fs-6";

        if (statusText === "APROVADO") statusEl.classList.add("bg-success");
        else if (statusText === "NEGADO") statusEl.classList.add("bg-danger");
        else if (statusText === "EM ANÁLISE") statusEl.classList.add("bg-warning", "text-dark");
        else if (statusText === "APROVADO COM RECOMENDAÇÕES") statusEl.classList.add("bg-warning", "text-dark");
        else statusEl.classList.add("bg-secondary");

        const modal = new bootstrap.Modal(document.getElementById("modalEvento"));
        modal.show();
      },

      eventDidMount: function (info) {
        info.el.setAttribute("title", info.event.title);
        info.el.style.cursor = "pointer";
      },
    });

    calendar.render();

    window.addEventListener("resize", () => {
      const mobileNow = window.matchMedia("(max-width: 768px)").matches;

      const desiredView = mobileNow ? "listWeek" : "dayGridMonth";
      if (calendar.view.type !== desiredView) calendar.changeView(desiredView);

      calendar.setOption("headerToolbar", {
        left: "prev,next today",
        center: "title",
        right: mobileNow ? "listWeek" : "dayGridMonth,listWeek",
      });
    });
  });

  if (sidebarToggle) {
    sidebarToggle.addEventListener("click", () => {
      if (window.innerWidth < 992) {
        body.classList.toggle("sidebar-open");
      } else {
        body.classList.toggle("sidebar-collapsed");
      }
      setTimeout(syncNavbarOffset, 50);
    });
  }
</script>

{% endblock %}
