{% extends "base.html" %}
{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">

    {# --- Cabe√ßalho --- #}
    <div class="d-flex align-items-center mb-3">
       <h2 class="text-dark m-0">
           <i class="bi bi-pencil-square me-2 text-primary"></i> Edi√ß√£o Completa de Solicita√ß√£o
       </h2>
    </div>

    {# --- Alerta de Cuidado (Mantido do original com leve estilo) --- #}
    <div class="alert alert-danger shadow-sm rounded-4 mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <strong>Aten√ß√£o Admin:</strong> Voc√™ est√° editando os dados originais da solicita√ß√£o diretamente.
            </div>
        </div>
    </div>

    {# --- Card Principal --- #}
    <div class="card info status-primary shadow-sm rounded-4 border-0">
        <div class="card-body p-4">
            
            {# Formul√°rio com Action Original #}
            <form action="{{ url_for('main.admin_editar_completo', id=pedido.id) }}" method="POST">
                
                <h5 class="text-secondary mb-4 small fw-bold text-uppercase border-bottom pb-2">
                    Pedido #{{ pedido.id }} - {{ pedido.usuario.nome_uvis }}
                </h5>

                {# --- SE√á√ÉO 1: AGENDAMENTO E FOCO --- #}
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Data e Opera√ß√£o</h5>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-calendar-date me-1 text-primary"></i> Data da Visita
                        </label>
                        <input type="date" class="form-control" id="data_agendamento" name="data_agendamento" 
                               value="{{ pedido.data_agendamento.isoformat() if pedido.data_agendamento else '' }}" required>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-clock me-1 text-primary"></i> Hor√°rio
                        </label>
                        <input type="time" class="form-control" id="hora_agendamento" name="hora_agendamento" 
                               value="{{ pedido.hora_agendamento.strftime('%H:%M') if pedido.hora_agendamento else '' }}" required>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-crosshair me-1 text-primary"></i> Foco Principal
                        </label>
                        <select name="foco" id="foco" class="form-select" required>
                            <option value="" disabled {% if not pedido.foco %}selected{% endif %}>Selecione...</option>
                            {% set focos = ['Im√≥vel Abandonado', 'Piscina / Caixa D\'√°gua', 'Terreno Baldio', 'Ponto Estrat√©gico (PE)'] %}
                            {% for foco_opcao in focos %}
                                <option value="{{ foco_opcao }}" {% if pedido.foco == foco_opcao %}selected{% endif %}>{{ foco_opcao }}</option>
                            {% endfor %}
                            {# Tratamento para valores antigos/personalizados #}
                            {% if pedido.foco and pedido.foco not in focos %}
                                <option value="{{ pedido.foco }}" selected>{{ pedido.foco }} (Valor Personalizado)</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <hr class="text-muted opacity-25 my-4">

                {# --- SE√á√ÉO 2: DETALHES OPERACIONAIS --- #}
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-sliders text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Detalhes Operacionais</h5>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-list-task me-1 text-primary"></i> Tipo de Visita
                        </label>
                        <select id="tipo_visita" name="tipo_visita" class="form-select">
                            {% set tv = pedido.tipo_visita or '' %}
                            <option value="Monitoramento" {% if tv == 'Monitoramento' %}selected{% endif %}>Monitoramento</option>
                            <option value="Aedes" {% if tv == 'Aedes' %}selected{% endif %}>Aedes</option>
                            <option value="Culex" {% if tv == 'Culex' %}selected{% endif %}>Culex</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-arrow-up me-1 text-primary"></i> Altura M√°xima
                        </label>
                        <select id="altura_voo" name="altura_voo" class="form-select">
                            {% set av = pedido.altura_voo or '' %}
                            <option value="10m" {% if av == '10m' %}selected{% endif %}>10m</option>
                            <option value="20m" {% if av == '20m' %}selected{% endif %}>20m</option>
                            <option value="30m" {% if av == '30m' %}selected{% endif %}>30m</option>
                            <option value="40m" {% if av == '40m' %}selected{% endif %}>40m</option>
                        </select>
                    </div>
                </div>

                {# Checkboxes estilizados #}
                <div class="row mb-3 p-3 rounded mx-1 border">
                    <label class="fw-bold d-block mb-2 text-muted small">
                        <i class="bi bi-cone-striped me-1 text-primary"></i> Necess√°rio Apoio CET?
                    </label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="apoio_cet" id="cetSim" value="sim">
                            <label class="form-check-label" for="cetSim">Sim</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="apoio_cet" id="cetNao" value="nao" checked>
                            <label class="form-check-label" for="cetNao">N√£o</label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted">
                        <i class="bi bi-card-text me-1 text-primary"></i> Observa√ß√µes da UVIS
                    </label>
                    <textarea class="form-control" id="observacao" name="observacao" rows="2">{{ pedido.observacao or '' }}</textarea>
                </div>

                <hr class="text-muted opacity-25 my-4">

                {# --- SE√á√ÉO 3: LOCALIZA√á√ÉO --- #}
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-geo-alt-fill text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Localiza√ß√£o</h5>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-search me-1 text-primary"></i> CEP
                        </label>
                        <input type="text" class="form-control" id="cep" name="cep" value="{{ pedido.cep or '' }}" required>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-signpost-2 me-1 text-primary"></i> Logradouro
                        </label>
                        <input type="text" class="form-control" id="logradouro" name="logradouro" value="{{ pedido.logradouro or '' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-hash me-1 text-primary"></i> N√∫mero
                        </label>
                        <input type="text" class="form-control" id="numero" name="numero" value="{{ pedido.numero or '' }}">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-map me-1 text-primary"></i> Bairro
                        </label>
                        <input type="text" class="form-control" id="bairro" name="bairro" value="{{ pedido.bairro or '' }}" required>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-building me-1 text-primary"></i> Cidade
                        </label>
                        <input type="text" class="form-control" id="cidade" name="cidade" value="{{ pedido.cidade or '' }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-flag me-1 text-primary"></i> UF
                        </label>
                        <input type="text" class="form-control" id="uf" name="uf" value="{{ pedido.uf or '' }}" maxlength="2" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-door-open me-1 text-primary"></i> Complemento
                        </label>
                        <input type="text" class="form-control" id="complemento" name="complemento" value="{{ pedido.complemento or '' }}">
                    </div>
                </div>

                <div class="row g-3 mb-4 mt-4 p-3 rounded mx-1 border border-light">
                    <div class="col-12 mb-3">
                        <label class="fw-bold small text-muted d-block">
                            <i class="bi bi-globe me-1 text-primary"></i> Coordenadas (Lat/Long)
                        </label>
                    </div>

                    <div class="col-md-6">
                        <input name="latitude" class="form-control form-control-sm font-monospace" placeholder="Latitude" value="{{ pedido.latitude or '' }}">
                    </div>
                    <div class="col-md-6">
                        <input name="longitude" class="form-control form-control-sm font-monospace" placeholder="Longitude" value="{{ pedido.longitude or '' }}">
                    </div>
                </div>

                <hr class="text-muted opacity-25 my-4">

                {# --- SE√á√ÉO 4: STATUS (ADMIN) --- #}
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-shield-lock-fill text-primary me-2 fs-5"></i>
                    <h5 class="m-0 text-primary fw-bold">Controle Interno (Admin)</h5>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-file-earmark-code me-1 text-primary"></i> Protocolo DECEA
                        </label>
                        <input name="protocolo" class="form-control font-monospace" id="protocolo" placeholder="BR-2025-XXXX" value="{{ pedido.protocolo or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-toggle-on me-1 text-primary"></i> Status Atual
                        </label>
                        <select name="status" id="status" class="form-select fw-semibold">
                            {% set status = pedido.status or 'PENDENTE' %}
                            <option value="PENDENTE" {% if status=='PENDENTE' %}selected{% endif %}>‚ö™Ô∏è Pendente</option>
                            <option value="EM AN√ÅLISE" {% if status=='EM AN√ÅLISE' %}selected{% endif %}>üü° Em An√°lise</option>
                            <option value="APROVADO" {% if status=='APROVADO' %}selected{% endif %}>üü¢ Aprovado</option>
                            <option value="APROVADO COM RECOMENDA√á√ïES" {% if status=='APROVADO COM RECOMENDA√á√ïES' %}selected{% endif %}>üü† Aprovado c/ Rec.</option>
                            <option value="NEGADO" {% if status=='NEGADO' %}selected{% endif %}>üî¥ Negado</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold small text-muted">
                            <i class="bi bi-chat-left-text me-1 text-primary"></i> Justificativa (Se Negado/Obs)
                        </label>
                        <input name="justificativa" class="form-control" id="justificativa" value="{{ pedido.justificativa or '' }}">
                    </div>
                </div>

                {# BOT√ïES #}
                <div class="d-flex justify-content-end gap-2 mt-5">
                    <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-outline-danger px-4">
                        <i class="bi bi-x-lg me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary px-4 shadow-sm fw-bold">
                        <i class="bi bi-check-lg me-1"></i> Salvar Altera√ß√µes
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
      // Listener para o campo CEP
      const cepInput = document.getElementById("cep");

      if (cepInput) {
          cepInput.addEventListener("keyup", function () {
            let val = this.value.replace(/\D/g, "");

            if (val.length === 8) {
                // Adiciona classe de loading
                this.classList.add('loading-spinner');
                this.disabled = true;

                // Limpa campos
                document.getElementById("logradouro").value = "";
                document.getElementById("bairro").value = "";
                document.getElementById("cidade").value = "";
                document.getElementById("uf").value = "";
                
                fetch(`https://viacep.com.br/ws/${val}/json/`)
                    .then((response) => response.json())
                    .then((data) => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                        this.focus();
                        
                        if (!data.erro) {
                            document.getElementById("logradouro").value = data.logradouro || "";
                            document.getElementById("bairro").value = data.bairro || "";
                            document.getElementById("cidade").value = data.localidade || "";
                            document.getElementById("uf").value = data.uf || "";
                            
                            // Foca no n√∫mero
                            document.getElementById("numero").focus();
                        } else {
                            // Feedback simples usando o SweetAlert padr√£o ou alert
                            if(typeof Swal !== 'undefined'){
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'warning',
                                    title: 'CEP n√£o encontrado.',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    customClass: {
                                        popup: document.body.classList.contains('dark-mode') ? 'swal2-dark-mode' : ''
                                    }
                                });
                            }
                        }
                    })
                    .catch(() => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                    });
            }
          });
      }
  });
</script>
{% endblock %}