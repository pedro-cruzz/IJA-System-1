{% extends "base.html" %}

{% block extra_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">

  <style>
    /* =========================
       RELATÓRIOS - HEADER (título + botões)
       ========================= */

    .rel-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
    }

    .rel-title h2{
      color: var(--bs-body-color);
    }

    .rel-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* botão export mais “premium” */
    .rel-btn{
      display:flex;
      align-items:center;
      gap: 10px;
      border-radius: 999px;
      padding: .65rem 1rem;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.08);
      white-space: nowrap;
    }

    /* ícone em bolinha (fica lindo no mobile) */
    .rel-btn i{
      width: 34px;
      height: 34px;
      display:grid;
      place-items:center;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
    }

    /* Desktop: deixa alinhado e equilibrado */
    @media (min-width: 992px){
      .rel-btn{
        min-width: 190px;
        justify-content: center;
      }
    }

    /* ✅ Mobile: título em cima e botões em grade */
    @media (max-width: 768px){
      .rel-header{
        flex-direction: column;
        align-items: stretch;
      }

      .rel-actions{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .rel-actions form{
        width: 100%;
      }

      .rel-btn{
        width: 100%;
        justify-content: center;
        padding: .9rem .8rem;
        border-radius: 18px;
        flex-direction: column;
        gap: 8px;
        text-align:center;
      }

      .rel-btn i{
        width: 44px;
        height: 44px;
        font-size: 1.1rem;
      }

      .rel-btn span{
        font-size: .92rem;
        line-height: 1.1;
      }
    }

    /* =========================
       DARK MODE (header)
       ========================= */
    html.dark-mode .rel-btn,
    body.dark-mode .rel-btn{
      border-color: #233549 !important;
      box-shadow: 0 14px 28px rgba(0,0,0,.35) !important;
    }

    /* PDF (btn-danger) no dark */
    html.dark-mode .btn.btn-danger.rel-btn,
    body.dark-mode .btn.btn-danger.rel-btn{
      filter: saturate(1.05);
    }

    /* Excel (btn-success) no dark */
    html.dark-mode .btn.btn-success.rel-btn,
    body.dark-mode .btn.btn-success.rel-btn{
      filter: saturate(1.05);
    }
  </style>
{% endblock %}


{% block content %}

{% set meses = {
    1: "Janeiro", 2: "Fevereiro", 3: "Março", 4: "Abril",
    5: "Maio", 6: "Junho", 7: "Julho", 8: "Agosto",
    9: "Setembro", 10: "Outubro", 11: "Novembro", 12: "Dezembro"
} %}

{% set status_cores = {
    "APROVADO": "success",
    "APROVADO COM RECOMENDAÇÕES": "success",
    "NEGADO": "danger",
    "EM ANÁLISE": "warning",
    "PENDENTE": "info"
} %}
<div class="container-fluid py-4" style="max-width: 1200px;">

    {# --- Cabeçalho e Bloco de Exportação --- #}
    <div class="rel-header mb-4">
  <div class="rel-title">
    <h2 class="m-0 fw-bold">
      <i class="bi bi-bar-chart-fill me-2 text-primary"></i> Relatórios
    </h2>
  </div>

  <div class="rel-actions">
    <form method="GET" action="{{ url_for('main.exportar_relatorio_pdf') }}" class="form-exportar p-0 m-0">
      <input type="hidden" name="mes" value="{{ mes_selecionado }}">
      <input type="hidden" name="ano" value="{{ ano_selecionado }}">
      <input type="hidden" name="uvis_id" value="{{ uvis_id_selecionado }}">
      <button type="submit" class="btn btn-danger bt-sm" title="Exportar PDF">
        <i class="bi bi-file-earmark-pdf-fill"></i>
        <span>Exportar PDF</span>
      </button>
    </form>

    <form method="GET" action="{{ url_for('main.exportar_relatorio_excel') }}" class="form-exportar p-0 m-0">
      <input type="hidden" name="mes" value="{{ mes_selecionado }}">
      <input type="hidden" name="ano" value="{{ ano_selecionado }}">
      <input type="hidden" name="uvis_id" value="{{ uvis_id_selecionado }}">
      <button type="submit" class="btn btn-success bt-sm" title="Exportar Excel">
        <i class="bi bi-file-earmark-excel-fill"></i>
        <span>Exportar Excel</span>
      </button>
    </form>
  </div>
</div>

{# --- FILTROS EM "SANFONA" (Accordion) --- #}
<div class="card shadow-sm rounded-4 mb-4 border-0">

    <!-- HEADER -->
    <div class="card-header border-0 p-3 d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse"
         data-bs-target="#collapseFiltros"
         aria-expanded="true"
         style="cursor: pointer;">

        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-funnel-fill text-primary"></i>
            <span class="text-dark">Filtros de busca</span>

            {# bolinha vermelha se houver filtros ativos #}
            {% if mes_selecionado or ano_selecionado or uvis_id_selecionado %}
                <span class="badge bg-danger rounded-circle p-1"
                      style="width: 8px; height: 8px;"></span>
            {% endif %}
        </div>

        <i class="bi bi-chevron-down text-muted"></i>
    </div>

    <!-- CORPO (SANFONA) -->
    <div class="collapse {% if request.args %}show{% endif %}" id="collapseFiltros">


        <div class="card-body pt-0">
            <form method="GET">
                <div class="row g-2 align-items-end">

                    <div class="col-md-3">
                        <label class="small text-muted">Mês:</label>
                        <select name="mes" class="form-select form-select-sm">
                            {% for num, nome in meses.items() %}
                                <option value="{{ num }}"
                                    {% if num|int == mes_selecionado|int %}selected{% endif %}>
                                    {{ nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="small text-muted">Ano:</label>
                        <select name="ano" class="form-select form-select-sm">
                            {% for ano in anos_disponiveis %}
                                <option value="{{ ano }}"
                                    {% if ano|int == ano_selecionado|int %}selected{% endif %}>
                                    {{ ano }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="small text-muted">Unidade (UVIS):</label>
                        <select name="uvis_id" class="form-select form-select-sm">
                            <option value="">Todas as Unidades</option>
                            {% for id, nome in uvis_disponiveis %}
                                <option value="{{ id }}"
                                    {% if id|int == uvis_id_selecionado|int %}selected{% endif %}>
                                    {{ nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3 d-flex gap-2">
                        <button class="btn btn-success btn-sm w-100" type="submit">
                            <i class="bi bi-funnel"></i> Filtrar
                        </button>

                        {% if mes_selecionado or ano_selecionado or uvis_id_selecionado %}
                            <a href="{{ url_for(request.endpoint) }}"
                               class="btn btn-outline-secondary btn-sm w-100">
                                <i class="bi bi-x-lg"></i> Limpar
                            </a>
                        {% endif %}
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>




    <h4 class="mb-4 text-primary">
        Dados de {{ meses[mes_selecionado|int] }} / {{ ano_selecionado }}
        {% if uvis_id_selecionado %}
            <small class="text-muted fst-italic">— Filtrado por:
                {{ uvis_disponiveis | selectattr(0, 'equalto', uvis_id_selecionado|int) | map(attribute=1) | first }}
            </small>
        {% endif %}
    </h4>

    <div class="row g-2 mb-4">

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-primary h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted">Total</h6>
            <h2 class="mb-0 fw-bold text-primary">{{ total_solicitacoes }}</h2>
        </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-success h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted">Aprovadas</h6>
            <h2 class="mb-0 fw-bold text-success">{{ total_aprovadas }}</h2>
        </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-recomended h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted" style="font-size: 0.85rem;">
            Aprovadas c/ Recom.
            </h6>
            <h2 class="mb-0 fw-bold text-recomended">{{ total_aprovadas_com_recomendacoes }}</h2>
        </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-danger h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted">Recusadas</h6>
            <h2 class="mb-0 fw-bold text-danger">{{ total_recusadas }}</h2>
        </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-warning h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted">Em Análise</h6>
            <h2 class="mb-0 fw-bold text-warning">{{ total_analise }}</h2>
        </div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-lg-2">
        <div class="card info status-info h-100 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body">
            <h6 class="text-uppercase mb-2 text-muted">Pendentes</h6>
            <h2 class="mb-0 fw-bold text-info">{{ total_pendentes }}</h2>
        </div>
        </div>
    </div>

    </div>


    {# =========================
        DASHBOARD DE GRÁFICOS
        ========================= #}
    <div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-pie-chart-fill me-2"></i>Status</h5>
            <span class="badge bg-light text-dark ">Período filtrado</span>
        </div>
        <div style="height:280px;">
            <canvas id="chartStatus"></canvas>
        </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-geo-alt-fill me-2"></i>Solicitações por Região</h5>
            <span class="badge bg-light text-dark">Período filtrado</span>
        </div>
        <div style="height:280px;">
            <canvas id="chartRegiao"></canvas>
        </div>
        </div>
    </div>
    </div>

    <div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-building-check me-2"></i>Unidades (UVIS)</h5>
            <span class="badge bg-light text-dark ">Top 10</span>
        </div>
        <div style="height:320px;">
            <canvas id="chartUnidade"></canvas>
        </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-bullseye me-2"></i>Foco</h5>
            <span class="badge bg-light text-dark ">Período filtrado</span>
        </div>
        <div style="height:320px;">
            <canvas id="chartFoco"></canvas>
        </div>
        </div>
    </div>
    </div>

    <div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-journal-text me-2"></i>Tipo de Visita</h5>
            <span class="badge bg-light text-dark ">Período filtrado</span>
        </div>
        <div style="height:320px;">
            <canvas id="chartTipoVisita"></canvas>
        </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm rounded-4 p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-dark"><i class="bi bi-ruler me-2"></i>Altura de Voo</h5>
            <span class="badge bg-light text-dark ">Período filtrado</span>
        </div>
        <div style="height:320px;">
            <canvas id="chartAltura"></canvas>
        </div>
        </div>
    </div>
    </div>

    {# --- Tabelas detalhadas: Região, Unidade, Status, Foco, Tipo, Altura --- #}
    <div class="card shadow-sm rounded-4 p-4 mb-4">
        <h4 class="mb-3 text-dark"><i class="bi bi-geo-alt-fill me-2"></i>Solicitações por Região</h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Região</th>
                        <th class="text-center">Total de Solicitações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for regiao, count in dados_regiao %}
                    <tr>
                        <td>{{ regiao or 'Não informado' }}</td>
                        <td class="text-center">{{ count }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="2" class="text-center text-muted">Nenhuma solicitação encontrada para este período.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card shadow-sm rounded-4 p-4 mb-4">
        <h4 class="mb-3 text-dark"><i class="bi bi-building-check me-2"></i>Solicitações por Unidade (UVIS)</h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Unidade (UVIS)</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unidade, total in dados_unidade %}
                    <tr>
                        <td>{{ unidade or 'Não informado' }}</td>
                        <td class="text-center">{{ total }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="2" class="text-center text-muted">Nenhuma solicitação encontrada para as unidades do período selecionado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm rounded-4 p-4 h-100">
                <h4 class="mb-3 text-dark"><i class="bi bi-list-task me-2"></i>Status Detalhado</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status, count in dados_status %}
                            <tr>
                                <td><span class="badge bg-{{ status_cores.get(status, 'secondary') }} text-uppercase">{{ status }}</span></td>
                                <td class="text-center">{{ count }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhum status encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm rounded-4 p-4 h-100">
                <h4 class="mb-3 text-dark"><i class="bi bi-bullseye me-2"></i>Solicitações por Foco</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Foco</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for foco, count in dados_foco %}
                            <tr>
                                <td>{{ foco or 'Não informado' }}</td>
                                <td class="text-center">{{ count }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhuma solicitação encontrada por foco.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm rounded-4 p-4 h-100">
                <h4 class="mb-3 text-dark"><i class="bi bi-journal-text me-2"></i>Solicitações por Tipo de Visita</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Tipo de Visita</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tipo, count in dados_tipo_visita %}
                            <tr>
                                <td>{{ tipo | capitalize or 'Não informado' }}</td>
                                <td class="text-center">{{ count }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhuma solicitação encontrada por tipo de visita.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm rounded-4 p-4 h-100">
                <h4 class="mb-3 text-dark"><i class="bi bi-ruler me-2"></i>Solicitações por Altura de Voo</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Altura (Metros)</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for altura, count in dados_altura_voo %}
                            <tr>
                                <td>{{ altura or 'Não informado' }}</td>
                                <td class="text-center">{{ count }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhuma solicitação encontrada por altura de voo.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# Histórico mensal (seu gráfico original, mantido) #}
    <div class="card shadow-sm rounded-4 p-4 mb-4">
        <h4 class="mb-3 text-dark"><i class="bi bi-graph-up me-2"></i>Solicitações por Mês (Histórico)</h4>
        <p class="text-muted mb-3">Visão geral da evolução ao longo do tempo, independente do filtro de período.</p>
        <div style="height:300px;">
            <canvas id="chartMensal"></canvas>
        </div>
    </div>

</div>

{# =========================
    JSONs para gráficos
    ========================= #}
<script id="dados-mensais-json" type="application/json">{{ dados_mensais | tojson | safe }}</script>
<script id="dados-status-json" type="application/json">{{ dados_status | tojson | safe }}</script>
<script id="dados-regiao-json" type="application/json">{{ dados_regiao | tojson | safe }}</script>
<script id="dados-unidade-json" type="application/json">{{ dados_unidade | tojson | safe }}</script>
<script id="dados-foco-json" type="application/json">{{ dados_foco | tojson | safe }}</script>
<script id="dados-tipo-visita-json" type="application/json">{{ dados_tipo_visita | tojson | safe }}</script>
<script id="dados-altura-json" type="application/json">{{ dados_altura_voo | tojson | safe }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // ================
    // Helpers
    // ================
    const readJson = (id) => {
        const el = document.getElementById(id);
        return el ? JSON.parse(el.textContent) : [];
    };

    const cleanLabel = (v) => (v === null || v === undefined || v === "" ? "Não informado" : String(v));

    // Tema global
    Chart.defaults.font.family = "system-ui, -apple-system, Segoe UI, Roboto, Arial";
    Chart.defaults.color = "#495057";
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.tooltip.backgroundColor = "rgba(33, 37, 41, 0.92)";
    Chart.defaults.plugins.tooltip.padding = 12;
    Chart.defaults.plugins.tooltip.titleColor = "#fff";
    Chart.defaults.plugins.tooltip.bodyColor = "#fff";
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    const palette = ["#0d6efd", "#20c997", "#ffc107", "#dc3545", "#6f42c1", "#0dcaf0", "#fd7e14", "#198754", "#adb5bd", "#343a40"];

    // =========================
    
    // Gráfico: Histórico Mensal (line)
    // =========================
    const dadosMensais = readJson("dados-mensais-json");
    const labelsMensais = dadosMensais.map(item => item[0]);
    const countsMensais = dadosMensais.map(item => item[1]);

    function formatarMes(label) {
        if (!label) return "";
        const [ano, mes] = label.split("-");
        const data = new Date(ano, mes - 1);
        const formatador = new Intl.DateTimeFormat("pt-BR", { month: "short", year: "2-digit" });
        return formatador.format(data).replace(".", "/").replace(" ", "");
    }

    const labelsMensaisFmt = labelsMensais.map(formatarMes);

    if (document.getElementById("chartMensal")) {
        new Chart(document.getElementById("chartMensal"), {
            type: "line",
            data: {
                labels: labelsMensaisFmt,
                datasets: [{
                    label: "Total de Solicitações",
                    data: countsMensais,
                    backgroundColor: "rgba(13, 110, 253, 0.15)",
                    borderColor: "#0d6efd",
                    borderWidth: 3,
                    tension: 0.35,
                    fill: true,
                    pointBackgroundColor: "#0d6efd",
                    pointBorderColor: "#fff",
                    pointRadius: 4
                }]
            },
            options: {
                interaction: { mode: "index", intersect: false },
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { precision: 0 } }
                }
            }
        });
    }

    // =========================
    // Região (bar horizontal)
    // =========================
    const dadosRegiao = readJson("dados-regiao-json").map(([r, c]) => [cleanLabel(r), c]);
    if (document.getElementById("chartRegiao")) {
        new Chart(document.getElementById("chartRegiao"), {
            type: "bar",
            data: {
                labels: dadosRegiao.map(x => x[0]),
                datasets: [{
                    label: "Solicitações",
                    data: dadosRegiao.map(x => x[1]),
                    backgroundColor: "#0d6efd",
                    borderRadius: 10,
                    barThickness: 18
                }]
            },
            options: {
                indexAxis: "y",
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { precision: 0 } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    // =========================
    // Unidade (Top 10) (bar)
    // =========================
    let dadosUnidade = readJson("dados-unidade-json").map(([u, c]) => [cleanLabel(u), c]).slice(0, 10);
    if (document.getElementById("chartUnidade")) {
        new Chart(document.getElementById("chartUnidade"), {
            type: "bar",
            data: {
                labels: dadosUnidade.map(x => x[0]),
                datasets: [{
                    label: "Total",
                    data: dadosUnidade.map(x => x[1]),
                    backgroundColor: "#20c997",
                    borderRadius: 10
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { precision: 0 } },
                    x: { grid: { display: false }, ticks: { maxRotation: 35, minRotation: 0 } }
                }
            }
        });
    }

    // =========================
    // Foco (bar horizontal)
    // =========================
    const dadosFoco = readJson("dados-foco-json").map(([f, c]) => [cleanLabel(f), c]);
    if (document.getElementById("chartFoco")) {
        new Chart(document.getElementById("chartFoco"), {
            type: "bar",
            data: {
                labels: dadosFoco.map(x => x[0]),
                datasets: [{
                    label: "Total",
                    data: dadosFoco.map(x => x[1]),
                    backgroundColor: "#6f42c1",
                    borderRadius: 10,
                    barThickness: 18
                }]
            },
            options: {
                indexAxis: "y",
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { precision: 0 } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    // =========================
    // Tipo de visita (doughnut)
    // =========================
    const dadosTipo = readJson("dados-tipo-visita-json").map(([t, c]) => [cleanLabel(t), c]);
    if (document.getElementById("chartTipoVisita")) {
        new Chart(document.getElementById("chartTipoVisita"), {
            type: "doughnut",
            data: {
                labels: dadosTipo.map(x => x[0]),
                datasets: [{
                    data: dadosTipo.map(x => x[1]),
                    backgroundColor: dadosTipo.map((_, i) => palette[i % palette.length]),
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                cutout: "65%",
                plugins: { legend: { position: "bottom" } }
            }
        });
    }

    // =========================
    // Altura de voo (bar)
    // =========================
    const dadosAltura = readJson("dados-altura-json").map(([a, c]) => [cleanLabel(a), c]);
    if (document.getElementById("chartAltura")) {
        new Chart(document.getElementById("chartAltura"), {
            type: "bar",
            data: {
                labels: dadosAltura.map(x => x[0]),
                datasets: [{
                    label: "Total",
                    data: dadosAltura.map(x => x[1]),
                    backgroundColor: "#fd7e14",
                    borderRadius: 10
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.06)" }, ticks: { precision: 0 } },
                    x: { grid: { display: false }, ticks: { maxRotation: 30, minRotation: 0 } }
                }
            }
        });
    }
</script>

<script>
    // =========================
    // Mapa fixo de cores por status
    // =========================
    const statusColorsMap = {
        "APROVADO": "#198754",     // verde
        "APROVADA": "#198754",
        "APROVADOS": "#198754",

        "RECUSADO": "#dc3545",     // vermelho
        "RECUSADA": "#dc3545",
        "RECUSADOS": "#dc3545",
        "NEGADO": "#dc3545",

        "EM ANÁLISE": "#ffc107",   // amarelo
        "EM ANALISE": "#ffc107",

        "PENDENTE": "#0d6efd",     // azul
        "PENDENTES": "#0d6efd",

        "APROVADO COM RECOMENDAÇÕES": "#ee650a",     // laranja
        "APROVADO COM RECOMENDACOES": "#ee650a"
    };

    // =========================
    // Status (doughnut)
    // =========================
    const dadosStatus = readJson("dados-status-json")
        .map(([status, count]) => [
            (status || "Não informado").toUpperCase(),
            count
        ]);

    if (document.getElementById("chartStatus")) {
        new Chart(document.getElementById("chartStatus"), {
            type: "doughnut",
            data: {
                labels: dadosStatus.map(item => item[0]),
                datasets: [{
                    data: dadosStatus.map(item => item[1]),
                    backgroundColor: dadosStatus.map(
                        item => statusColorsMap[item[0]] || "#adb5bd"
                    ),
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                cutout: "70%",
                plugins: {
                    legend: {
                        position: "bottom"
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.label}: ${ctx.parsed}`
                        }
                    }
                }
            }
        });
    }
</script>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        
        // Seleciona todos os formulários de exportação
        const exportForms = document.querySelectorAll('form.form-exportar');
        
        exportForms.forEach(form => {
            
            // Listener para a submissão do formulário (o listener universal aplica o loading)
            form.addEventListener('submit', function(e) {
                const submitButton = this.querySelector('button[type="submit"]');

                if (submitButton) {
                    const clickedButton = submitButton;

                    // 1. O loading já foi aplicado pelo base.html (listener universal)
                    
                    // 2. FORÇA A REVERSÃO do loading após 4 segundos (tempo razoável para download)
                    setTimeout(() => {
                        // Verifica se a função global está disponível antes de chamar
                        if (typeof hideLoadingState === 'function') {
                            hideLoadingState(clickedButton);
                        }
                    }, 4000); 
                    
                    // Não há e.preventDefault() aqui para garantir que o formulário submeta
                    // e inicie o download.
                }
            });
        });
    });
</script>

{% endblock %}