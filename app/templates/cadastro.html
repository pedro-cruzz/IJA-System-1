{% extends "base.html" %} 
{% block extra_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">
  
  {# --- Cabeçalho --- #}
  <div class="d-flex align-items-center mb-4">
      <h2 class="text-dark m-0">
          <i class="bi bi-send-fill me-2 text-primary"></i> Novo Pedido de Voo
      </h2>
  </div>

  {# --- Card Principal --- #}
  <div class="card info status-primary shadow-sm rounded-4 border-0">
    <div class="card-body p-4">
      
      <form method="POST">
        
        {# SEÇÃO 1: AGENDAMENTO #}
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
            <h5 class="m-0 text-primary fw-bold">Agendamento</h5>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-calendar-date me-1 text-primary"></i> Data da Visita *
            </label>
            <input type="date" name="data" class="form-control" required min="{{ hoje }}">
          </div>
          
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-clock me-1 text-primary"></i> Horário Previsto *
            </label>
            <input type="time" name="hora" class="form-control" required>
          </div>
        </div>

        <hr class="text-muted opacity-25 my-4">

        {# SEÇÃO 2: LOCALIZAÇÃO #}
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-geo-alt-fill text-primary me-2 fs-5"></i>
            <h5 class="m-0 text-primary fw-bold">Localização</h5>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-search me-1 text-primary"></i> CEP *
            </label>
            <input type="text" id="cep" name="cep" maxlength="9" class="form-control" placeholder="00000-000" required>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-signpost-2 me-1 text-primary"></i> Logradouro *
            </label>
            <input type="text" id="endereco" name="logradouro" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-hash me-1 text-primary"></i> Número *
            </label>
            <input type="text" name="numero" class="form-control" required>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-door-open me-1 text-primary"></i> Complemento
            </label>
            <input type="text" name="complemento" class="form-control" placeholder="Ex: Apto 102">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-map me-1 text-primary"></i> Bairro *
            </label>
            <input type="text" id="bairro" name="bairro" class="form-control" required>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-9">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-building me-1 text-primary"></i> Cidade *
            </label>
            <input type="text" id="cidade" name="cidade" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-flag me-1 text-primary"></i> UF *
            </label>
            <input type="text" id="uf" name="uf" class="form-control" required>
          </div>
        </div>

        <div class="row g-3 mb-4">
           <div class="col-md-6">
             <label class="form-label fw-bold small text-muted">
                <i class="bi bi-globe me-1 text-primary"></i> Latitude
             </label>
             <input type="text" name="latitude" class="form-control form-control-sm font-monospace" placeholder="-23.XXXXXX">
           </div>
           <div class="col-md-6">
             <label class="form-label fw-bold small text-muted">
                <i class="bi bi-globe me-1 text-primary"></i> Longitude
             </label>
             <input type="text" name="longitude" class="form-control form-control-sm font-monospace" placeholder="-46.XXXXXX">
           </div>
        </div>

        <hr class="text-muted opacity-25 my-4">

        {# SEÇÃO 3: DETALHES DA OPERAÇÃO #}
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-sliders text-primary me-2 fs-5"></i>
            <h5 class="m-0 text-primary fw-bold">Detalhes da Operação</h5>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-list-task me-1 text-primary"></i> Tipo de Visita *
            </label>
            <select class="form-select" name="tipo_visita" required>
              <option value="" selected disabled>Selecione...</option>
              <option value="Monitoramento">Monitoramento</option>
              <option value="Aedes">Aedes</option>
              <option value="Culex">Culex</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label fw-bold small text-muted">
                <i class="bi bi-arrow-up me-1 text-primary"></i> Altura do Voo *
            </label>
            <select class="form-select" name="altura_voo" required>
              <option value="" selected disabled>Selecione...</option>
              <option value="10m">10 Metros</option>
              <option value="20m">20 Metros</option>
              <option value="30m">30 Metros</option>
              <option value="40m">40 Metros</option>
            </select>
          </div>
        </div>

        <div class="row mb-3 p-3 rounded mx-1 border">
            <label class="fw-bold d-block mb-2 text-muted small">
                <i class="bi bi-cone-striped me-1 text-primary"></i> Necessário Apoio CET?
            </label>
            <div class="d-flex gap-4">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="apoio_cet" id="cetSim" value="sim">
                  <label class="form-check-label" for="cetSim">Sim</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="apoio_cet" id="cetNao" value="nao" checked>
                  <label class="form-check-label" for="cetNao">Não</label>
                </div>
            </div>
        </div>

        <div class="mb-4">
          <label class="form-label fw-bold small text-muted">
            <i class="bi bi-card-text me-1 text-primary"></i> Observações
          </label>
          <textarea class="form-control" name="observacao" rows="3" placeholder="Informações adicionais relevantes..."></textarea>
        </div>

        <hr class="text-muted opacity-25 my-4">

        {# SEÇÃO 4: CLASSIFICAÇÃO #}
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-bullseye text-primary me-2 fs-5"></i>
            <h5 class="m-0 text-primary fw-bold">Classificação</h5>
        </div>

        <div class="mb-4">
          <label class="form-label fw-bold small text-muted">
            <i class="bi bi-crosshair me-1 text-primary"></i> Foco da Ação *
          </label>
          <select name="foco" class="form-select" required>
            <option value="" selected disabled>Selecione o tipo de foco...</option>
            <option>Imóvel Abandonado</option>
            <option>Piscina / Caixa D'água</option>
            <option>Terreno Baldio</option>
            <option>Ponto Estratégico (PE)</option>
          </select>
        </div>

        {# BOTÕES #}
        <div class="d-flex justify-content-end gap-2 mt-5">
          <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-danger px-4">
              <i class="bi bi-x-lg me-1"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary px-5 shadow-sm fw-bold">
            <i class="bi bi-send me-1"></i> Enviar Pedido
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
      // Listener para o campo CEP
      const cepInput = document.getElementById("cep");

      if (cepInput) {
          cepInput.addEventListener("keyup", function () {
            let val = this.value.replace(/\D/g, "");

            if (val.length === 8) {
                // Adiciona classe de loading
                this.classList.add('loading-spinner');
                this.disabled = true;

                // Limpa campos
                document.getElementById("endereco").value = "";
                document.getElementById("bairro").value = "";
                document.getElementById("cidade").value = "";
                document.getElementById("uf").value = "";
                
                fetch(`https://viacep.com.br/ws/${val}/json/`)
                    .then((response) => response.json())
                    .then((data) => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                        this.focus();
                        
                        if (!data.erro) {
                            document.getElementById("endereco").value = data.logradouro || "";
                            document.getElementById("bairro").value = data.bairro || "";
                            document.getElementById("cidade").value = data.localidade || "";
                            document.getElementById("uf").value = data.uf || "";
                            
                            // Foca no número
                            document.querySelector('input[name="numero"]').focus();
                        } else {
                            if(typeof Swal !== 'undefined'){
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'warning',
                                    title: 'CEP não encontrado.',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    customClass: {
                                        popup: document.body.classList.contains('dark-mode') ? 'swal2-dark-mode' : ''
                                    }
                                });
                            }
                        }
                    })
                    .catch(() => {
                        this.classList.remove('loading-spinner');
                        this.disabled = false;
                        
                        if(typeof Swal !== 'undefined'){
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'error',
                                title: 'Erro ao consultar CEP.',
                                showConfirmButton: false,
                                timer: 3000,
                                customClass: {
                                    popup: document.body.classList.contains('dark-mode') ? 'swal2-dark-mode' : ''
                                }
                            });
                        }
                    });
            }
          });
      }
  });
</script>
{% endblock %}